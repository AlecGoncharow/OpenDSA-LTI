<!DOCTYPE html>

<html>
	<head>
		<title>FA Container</title>
    	<link rel="stylesheet" href="../css/JSAV.css" type="text/css" media="screen" title="no title" charset="utf-8" />
		<base href="./editor.html" target="iframe">
	</head>
	<body onload="init()">
		<h1>FA Editor</h1>
		<p align="center" id="multipleTraversals" class="arrayPlace"></p>
		<iframe height="680px" width="100%" id="if" name="iframe" onload="onLoadHandler()"></iframe>
		<div id="av" style="display:none"></div>
		<button onclick="displayEditor()" id="edit">Edit</button>
		<button onclick="displayTraversals()" id="begin">Traverse</button>
		<button onclick="save()" id="saveButton">Save</button>
		<button type="submit" onclick="loadNewFile()">Load</button>
		<input type="file" accept=".json" id="loadFile" onchange="setSaved()">
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
		<script src="../lib/raphael.js"></script>
   		<script src="../lib/dagre.min.js"></script>
		<script src="../lib/jquery.transit.js"></script>
		<script src="../build/JSAVedit.js"></script>
		<script src="../resources/serializableGraph.js"></script>
		<script src="../resources/underscore-min.js"></script>
		<script src="../resources/FA.js"></script>
		<script>
			var jsav = new JSAV("av"),
				jsavArray,
				saved = false,
				traversal = "",
				serialization,
				editing,
				data;
		    
		    var displayEditor = function () {
		    	jsavArray.hide();
		    	if(editing) {
		    		return;
		    	}
		    	editing = true;
		    	serialization = document.getElementById("if").contentWindow.getSerial();
		    	document.getElementById("if").src = "./editor.html";
		    };
			var displayTraversals = function () {
				var inputString = prompt("Input string?");
				if (!inputString) {
					return;
				}
				var graph = document.getElementById("if").contentWindow.getGraph();
				serialization = document.getElementById("if").contentWindow.getSerial();
				var travArray = [];
				var inputs = inputString.split(',');
				jsav.umsg("");
				$("#mode").html('');
				for (var i = 0; i < inputs.length; i++) {
    				travArray.push(inputs[i]);
  				}
  				document.getElementById("multipleTraversals").innerHTML = "";
  				jsavArray = jsav.ds.array(travArray, {element: $('.arrayPlace')});
  				for (var j = 0; j < travArray.length; j++) {
  					if(willReject(graph, travArray[j])){
  						jsavArray.css(j, {"background-color": "red"});
  					}
  					else {
  						jsavArray.css(j, {"background-color": "green"});
  					}
  				}
  				jsavArray.click(arrayClickHandler);
  				jsavArray.show();
  				jsav.displayInit();
  			};
  			function arrayClickHandler(index) {
  				play(this.value(index));
  			};
			var play = function (inputString) {
				traversal = inputString;
				editing = false;
				document.getElementById("if").src = "./traversal.html";
			};
			var willReject = function (graph, inputString) {
				var currentStates = [graph.initial];
				currentStates = addLambdaClosure(graph, currentStates);
				var cur;
				for (var i = 0; i < inputString.length; i++) {
					for (var j = 0; j < currentStates.length; j++) {
				   		currentStates[j].removeClass('current');
				   	}
				   	cur = traverse(graph, currentStates, inputString[i]);
				   	if (cur.length == 0) {
				   		break;
				   	}
					currentStates = cur;
				}
				var rejected = true;
				for (var k = 0; k < currentStates.length; k++) {
					currentStates[k].removeClass('current');
					if (currentStates[k].hasClass('final') && cur.length > 0) {
						rejected = false;
					}
				}
				return rejected;
  			};
			var traverse = function(graph, currentStates, letter) {
				var nextStates = [];
				for (var i = 0; i < currentStates.length; i++) {
					var successors = currentStates[i].neighbors();
					for (var next = successors.next(); next; next = successors.next()) {
						var weight = graph.getEdge(currentStates[i], next).weight().split(',');
						for (var j = 0; j < weight.length; j++) {
							if (letter == weight[j] && !next.hasClass('current')) {
								next.addClass('current');
								nextStates.push(next);
							}
						}
					}
				}
				nextStates = addLambdaClosure(graph, nextStates);
				return nextStates;
			};
			var addLambdaClosure = function(graph, nextStates) {
				lambdaStates = [];
				for (var i = 0; i < nextStates.length; i++) {
					var successors = nextStates[i].neighbors();
					for (var next = successors.next(); next; next = successors.next()) {
						var weight = graph.getEdge(nextStates[i], next).weight().split(',');
						for (var j = 0; j < weight.length; j++) {
							if (weight[j] == "&lambda;" && !next.hasClass('current')) {
								next.addClass('current');
								lambdaStates.push(next);
							}
						}
					}
				}
				if(lambdaStates.length > 0) {
					lambdaStates = addLambdaClosure(graph, lambdaStates);
				}
				for (var k = 0; k < lambdaStates.length; k++) {
					nextStates.push(lambdaStates[k]);
				}
				return nextStates;
			};
			var setSaved = function () {
				saved = true;
			};
			var save = function () {
				document.getElementById("if").contentWindow.save();
			};
			var loadNewFile = function () {
				if (!saved) {
					return;
				}
				if (jsavArray) {
					jsavArray.hide();
				}
				editing = true;
				data = document.getElementById("loadFile").files[0];
				document.getElementById("if").src = "./editor.html";
				jsav.displayInit();
			};
			function onLoadHandler() {
				if (!saved) {
					var defaultData = '{"nodes":[{"left":818.15625,"top":138.03125,"i":true,"f":false},{"left":511.34375,"top":342,"i":false,"f":false},{"left":1055,"top":340.359375,"i":false,"f":false},{"left":480.8125,"top":144.4375,"i":false,"f":false},{"left":336.09375,"top":0,"i":false,"f":false},{"left":0,"top":183.3125,"i":false,"f":true}],"edges":[{"start":0,"end":1,"weight":"a"},{"start":0,"end":2,"weight":"b,a"},{"start":0,"end":3,"weight":"&lambda;"},{"start":1,"end":3,"weight":"a"},{"start":1,"end":2,"weight":"b"},{"start":2,"end":0,"weight":"a"},{"start":3,"end":4,"weight":"b"},{"start":3,"end":5,"weight":"a"},{"start":3,"end":3,"weight":"a"},{"start":4,"end":0,"weight":"a"},{"start":4,"end":5,"weight":"&lambda;"},{"start":5,"end":1,"weight":"&lambda;"}]}';
					document.getElementById("if").contentWindow.initialize(defaultData, traversal);
				}
				else if (data) {
					var reader = new FileReader();
					reader.onload = loadComplete;
					reader.readAsText(data);
					function loadComplete() {
						var readerData = reader.result;
						document.getElementById("if").contentWindow.initialize(readerData, traversal);
					}
					data = null;
				}
				else {
					document.getElementById("if").contentWindow.initialize(serialization, traversal);
				}
			};
			function init() {
				editing = true;
				document.getElementById("if").src = "./editor.html";
			};
   		</script>
   	</body>
</html>